# Replication Package: Deep Graph-Learning Methods for Stock Price Prediction

This replication package contains all code necessary to reproduce the experimental results from the paper on deep graph-learning methods for stock price prediction on S&P 500 stocks.

## Quick Start: Running the Replication Package End-to-End

```bash
# 1. Create and activate Python virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# 2. Install PyTorch (select the appropriate wheel)
# Use the command generated by https://pytorch.org/get-started/locally/ for your OS, Python version, and CUDA toolkit.

# 3. Install remaining dependencies
pip install -r requirements.txt

# 4. Prepare your data (see data/documentation/DATA_FORMAT.md)
#    Place your data files in data/SP500/raw/ following the documented format

# 5. Run all experiments
cd experiments
export PYTHONPATH=..  # On Windows: set PYTHONPATH=..
python run_all.py

# 6. Review outputs
#    - Metrics saved to: experiments/metrics.csv
#    - Per-run metadata saved to: experiments/run_metadata/
#    - Generated graphs saved to: data/graphs/
```

## Overview

This package implements and evaluates multiple deep learning architectures for stock price prediction:
- **Sequential Models**: MLP, GRU, LSTM
- **Spatiotemporal Models**: DCRNN, TGCN, A3TGCN

The models are evaluated across different graph construction strategies:
- Wikidata knowledge graph relationships
- Price correlation networks  
- Sector-based industry groupings

Note: The Wikidata queries can be slow on first run but results are cached locally.

## System Requirements

### Hardware
- **GPU**: NVIDIA GPU with CUDA support (tested on RTX 3090)
- **Memory**: 16GB+ RAM recommended
- **Storage**: ~1GB for code and data

### Software
- **OS**: Linux, macOS, or Windows with WSL
- **Python**: 3.8+
- **CUDA**: 11.8+ (for GPU acceleration)

### Expected Runtime
- Full replication: ~2-6 hours on NVIDIA RTX 3090 GPU
- Per phase/model: ~1-5 minutes depending on model complexity

## Repository Structure

```
.
├── README.md                     # This file
├── INSTALL.md                    # Detailed installation instructions
├── LICENSE                       # MIT License
├── requirements.txt              # Python dependencies
│
├── data/                         # Data directory
│   ├── documentation/            # Data format specifications
│   │   └── DATA_FORMAT.md       # Required data format details
│   ├── raw/                      # Raw data files (user-provided)
│   ├── processed/                # Processed PyTorch Geometric data
│   └── get_wikidata.py          # Wikidata knowledge graph fetcher
│
├── src/                          # Source code
│   ├── datasets/                 # Dataset classes and preprocessing
│   │   ├── SP500Stocks.py       # Main PyG dataset class
│   │   ├── csv_processing/      # Data preprocessing utilities
│   │   └── graph_construction/  # Graph edge formation methods
│   ├── models/                   # Model implementations
│   │   ├── MLP.py, GRU.py, LSTM.py
│   │   ├── DCRNN.py, TGCN.py, A3TGCN.py
│   │   └── ...
│   └── utils/                    # Training and evaluation utilities
│       ├── train.py
│       ├── evaluate.py
│       └── train_and_evaluate.py
│
├── experiments/                  # Experiment scripts
│   ├── run_all.py               # Main replication script
│   ├── config/                  # Configuration files
│   │   └── experiment_config.py # Hyperparameters and settings
│   └── notebooks/               # Jupyter notebooks
│       └── lseg-data-collection.ipynb
│   └── run_metadata/            # JSON metadata for each experiment run (auto-generated)
│
├── analysis/                     # Post-experiment analysis
│   ├── README.md                # Analysis script documentation
│   └── *.py                     # Visualization scripts
│
└── tests/                        # Unit tests (optional)
```

## Data Requirements

**Note**: Due to licensing restrictions, raw stock price data is **not included** in this package.

You must provide your own data following the format specified in `data/documentation/DATA_FORMAT.md`. The experiments require:
- Daily OHLCV data for S&P 500 stocks (2013-2024)
- Technical indicators (RSI, Average Log Returns)
- Market phase segmentation (200-day non-overlapping intervals)

See `experiments/notebooks/lseg-data-collection.ipynb` for an example of data collection methodology (requires LSEG Refinitiv access).

## Reproducing Results

### Step 1: Installation
See `INSTALL.md` for detailed setup instructions.

### Step 2: Data Preparation
1. Obtain stock price data from your preferred source
2. Format according to `data/documentation/DATA_FORMAT.md`
3. Place files in `data/SP500/raw/` directory

### Step 3: Run Experiments
```bash
cd experiments
export PYTHONPATH=..
python run_all.py
```

The script will:
- Load each market phase sequentially
- Construct graphs using different edge formation strategies
- Train all models (MLP, GRU, LSTM, DCRNN, TGCN, A3TGCN)
- Evaluate on held-out test sets
- Save results to `metrics.csv`
- Write per-run metadata JSON files to `run_metadata/`

### Step 4: Analysis
Navigate to the `analysis/` directory to generate visualizations:
```bash
cd analysis
python model_comparison.py      # Compare model performance
python graph_centrality.py      # Analyze graph structures
```

## Configuration

Hyperparameters and experimental settings can be modified in `experiments/config/experiment_config.py`:

- **Training**: epochs, learning rate, batch size
- **Data**: past window size, train/test split
- **Reproducibility**: random seed (set to 42 by default)
- **Models**: enable/disable specific models
- **Graph Construction**: edge formation strategies

## Key Features

### Reproducibility
- Fixed random seeds (configurable)
- Deterministic PyTorch operations
- Version-pinned dependencies
- Experiment logging and per-run metadata (JSON files)

### Modularity
- Clean separation of data, models, and experiments
- Easy to add new models or graph construction methods
- Configurable hyperparameters

### Transparency
- Well-documented code with docstrings
- Clear data format specifications
- Detailed installation instructions

## Citation

```
Zhang, J., & Bartolucci, F. (2025). Deep Graph-Learning Methods for Stock Price Prediction.
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Contact

For questions or issues, please open an issue on the repository.

## Acknowledgments

This work builds upon:
- PyTorch Geometric (Fey & Lenssen, 2019)
- PyTorch Geometric Temporal (Rozemberczki et al., 2021)
- Wikidata knowledge graph

## Additional Documentation

- `INSTALL.md` - Detailed installation and setup guide
- `data/documentation/DATA_FORMAT.md` - Data format specifications
- `analysis/README.md` - Post-processing and visualization guide
- `experiments/config/experiment_config.py` - Configuration documentation (hyperparameters, dataset & graph options)

## Wikidata & Graph Construction Notes

- By default, **external Wikidata requests are disabled** (`allow_external_requests=False`).
- Populate cached Wikidata mappings/edges in `data/SP500/cache/` (created automatically) or enable live queries by setting `GRAPH_OPTIONS["allow_external_requests"] = True` in `experiments/config/experiment_config.py`.
- Graph visualisation is disabled by default; enable it by setting `GRAPH_OPTIONS["visualise"] = True` for interactive inspection.
- Adjacency CSVs for each phase/strategy combination are saved to `data/graphs/<strategy>/`.
